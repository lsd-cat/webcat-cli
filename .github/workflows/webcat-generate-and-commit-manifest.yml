name: Generate and Commit WEBCAT Manifest

on:
  workflow_call:
    inputs:
      manifest_path:
        type: string
        required: false
        default: ".well-known/webcat/manifest.json"
        description: Where to write the signed manifest
      node_version:
        type: string
        required: false
        default: "20"

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  manifest:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout target repo (only to commit the manifest)
      - name: Check out target repository
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}

      # 3. Download inputs
      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: webcat-dist
          path: webcat-dist

      - name: Download WEBCAT config
        uses: actions/download-artifact@v4
        with:
          name: webcat-config
          path: webcat-config

      # 4. Validate inputs
      - name: Validate inputs
        run: |
          set -euo pipefail
          test -d webcat-dist
          test -f webcat-config/webcat.config.json

      # 5. Checkout webcat-cli
      - name: Check out webcat-cli
        uses: actions/checkout@v4
        with:
          repository: freedomofpress/webcat-cli
          ref: main
          path: webcat-cli

      # 6. Install webcat-cli dependencies
      - name: Install webcat-cli dependencies
        working-directory: webcat-cli
        run: npm ci

      # 7. Generate unsigned manifest
      - name: Generate WEBCAT manifest
        run: |
          set -euo pipefail

          mkdir -p "$(dirname "${{ inputs.manifest_path }}")"

          npx tsx webcat-cli/src/cli.ts manifest generate \
            --type sigstore \
            --config "webcat-config/webcat.config.json" \
            --directory "webcat-dist" \
            --output "${{ inputs.manifest_path }}"

      # 8. Obtain GitHub OIDC token
      - name: Get GitHub OIDC token
        id: oidc
        run: |
          set -euo pipefail

          TOKEN="$(curl -s \
            -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sigstore" \
            | jq -r .value)"

          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"

      # 9. Sign manifest
      - name: Sign manifest with Sigstore
        run: |
          set -euo pipefail

          npx tsx webcat-cli/src/cli.ts manifest sign \
            --type sigstore \
            --input "${{ inputs.manifest_path }}" \
            --output "${{ inputs.manifest_path }}" \
            --oidc-token "${{ steps.oidc.outputs.token }}"

      # 10. Commit signed manifest back
      - name: Commit signed manifest
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update signed manifest"
          title: "chore: update signed manifest"
          body: |
            This PR updates the signed WEBCAT manifest.

            - Generated from artifact: webcat-dist
            - Config: webcat-config/webcat.config.json
            - Signed using GitHub Actions OIDC + Sigstore
            - Issuer: https://token.actions.githubusercontent.com
          branch: "chore/update-webcat-manifest"
          delete-branch: false
          add-paths: |
            ${{ inputs.manifest_path }}
