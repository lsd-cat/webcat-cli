name: Assemble WEBCAT Bundle

on:
  workflow_call:
    inputs:
      enrollment_path:
        type: string
        required: false
        default: ".well-known/webcat/enrollment.json"
        description: Path to enrollment.json
      manifest_path:
        type: string
        required: false
        default: ".well-known/webcat/manifest.json"
        description: Path to signed manifest.json
      bundle_path:
        type: string
        required: false
        default: ".well-known/webcat/bundle.json"
        description: Where to write bundle.json
      branch:
        type: string
        required: false
        default: "chore/update-webcat-manifest"
        description: Branch to commit bundle to
      node_version:
        type: string
        required: false
        default: "20"

permissions:
  contents: write

jobs:
  bundle:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the target repo on the same branch
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      # 2. Setup Node
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}

      # 3. Validate inputs
      - name: Validate inputs
        run: |
          set -euo pipefail
          test -f "${{ inputs.enrollment_path }}"
          test -f "${{ inputs.manifest_path }}"

      # 4. Checkout webcat-cli
      - name: Check out webcat-cli
        uses: actions/checkout@v4
        with:
          repository: freedomofpress/webcat-cli
          ref: main
          path: webcat-cli

      # 5. Install webcat-cli deps
      - name: Install webcat-cli dependencies
        working-directory: webcat-cli
        run: npm ci

      # 6. Create bundle
      - name: Create Sigstore bundle
        run: |
          set -euo pipefail

          mkdir -p "$(dirname "${{ inputs.bundle_path }}")"

          npx tsx webcat-cli/src/cli.ts bundle create \
            -e "${{ inputs.enrollment_path }}" \
            -m "${{ inputs.manifest_path }}" \
            -o "${{ inputs.bundle_path }}"

      # 7. Commit bundle
      - name: Commit bundle
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add "${{ inputs.bundle_path }}"
          if git diff --cached --quiet; then
            echo "No bundle changes"
            exit 0
          fi

          git commit -m "chore: assemble bundle"
          git push origin "${{ inputs.branch }}"


