name: Sync Sigstore Enrollment

on:
  workflow_call:
    inputs:
      issuer:
        type: string
        required: true
      identity:
        type: string
        required: true
      max_age:
        type: string
        required: false
        default: "15552000"
      node_version:
        type: string
        required: false
        default: "20"
      enrollment_path:
        type: string
        required: false
        default: ".well-known/webcat/enrollment.json"
      bundle_path:
        type: string
        required: false
        default: ".well-known/webcat/bundle.json"


permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout target repo
      - name: Check out target repository
        uses: actions/checkout@v4

      # 2. Setup Node
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}

      # 3. Checkout webcat-cli (tool repo)
      - name: Check out webcat-cli
        uses: actions/checkout@v4
        with:
          repository: freedomofpress/webcat-cli
          ref: main
          path: webcat-cli

      # 4. Install webcat-cli deps
      - name: Install webcat-cli dependencies
        working-directory: webcat-cli
        run: npm ci

      # 5. Generate enrollment
      - name: Generate sigstore enrollment
        id: enrollment
        env:
          ISSUER: ${{ inputs.issuer }}
          IDENTITY: ${{ inputs.identity }}
          MAX_AGE: ${{ inputs.max_age }}
          ENROLLMENT_PATH: ${{ inputs.enrollment_path }}
          BUNDLE_PATH: ${{ inputs.bundle_path }}
        run: |
          set -euo pipefail

          tmp_file="$(mktemp)"
          directory="$(dirname "$ENROLLMENT_PATH")"
          prev_path="${directory}/enrollment-prev.json"
          prev_bundle_path="${directory}/bundle-prev.json"

          mkdir -p "$directory"

          npx tsx webcat-cli/src/cli.ts enrollment create \
            --type sigstore \
            --community-trusted-root \
            --issuer "$ISSUER" \
            --identity "$IDENTITY" \
            --max-age "$MAX_AGE" \
            --output "$tmp_file"

          # Fresh start: no existing enrollment
          if [ ! -f "$ENROLLMENT_PATH" ]; then
            mv "$tmp_file" "$ENROLLMENT_PATH"
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Existing enrollment: check for changes
          if cmp -s "$tmp_file" "$ENROLLMENT_PATH"; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            rm -f "$tmp_file"
            exit 0
          fi

          # Save previous version
          cp "$ENROLLMENT_PATH" "$prev_path"
          [ -f "$BUNDLE_PATH" ] && cp "$BUNDLE_PATH" "$prev_bundle_path"

          mv "$tmp_file" "$ENROLLMENT_PATH"
          echo "changed=true" >> "$GITHUB_OUTPUT"

      # 6. Prepare PR body
      - name: Prepare pull request details
        if: steps.enrollment.outputs.changed == 'true'
        env:
          ISSUER: ${{ inputs.issuer }}
          IDENTITY: ${{ inputs.identity }}
          MAX_AGE: ${{ inputs.max_age }}
          ENROLLMENT_PATH: ${{ inputs.enrollment_path }}
        run: |
          set -euo pipefail

          PR_BODY="${RUNNER_TEMP}/pr-body.md"

          {
            echo "## Sigstore enrollment update"
            echo
            echo "- Issuer: $ISSUER"
            echo "- Identity: $IDENTITY"
            echo "- Max age: $MAX_AGE"
            echo
            echo "### Diff"
            echo
            echo "```diff"
            git diff -- "$ENROLLMENT_PATH"
            echo "```"
          } > "$PR_BODY"

      # 7. Open or update a single rolling PR
      - name: Open pull request
        if: steps.enrollment.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update sigstore enrollment"
          title: "chore: update sigstore enrollment"
          body-path: ${{ runner.temp }}/pr-body.md
          branch: "chore/update-sigstore-enrollment"
          delete-branch: false
          add-paths: |
            ${{ inputs.enrollment_path }}
            .well-known/webcat/enrollment-prev.json
